<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PIP Clock + Rates</title>

<style>
  body {
    margin: 0;
    background: black;
    color: white;
    font-family: 'Courier New', monospace;
    text-align: center;
  }

  #clock {
    font-size: 12vw;
    margin-top: 10px;
    font-weight: bold;
    text-shadow: 0 0 10px #fff, 0 0 20px #0ff;
  }

  .rate {
    font-size: 6vw;
    margin-top: 5px;
    font-weight: bold;
  }

  #pipButton {
    margin-top: 20px;
    padding: 12px 24px;
    font-size: 6vw;
    background: #444;
    color: white;
    border-radius: 12px;
    border: 2px solid #888;
  }

  /* Safari で PiP を許可させるため「可視扱い」にする */
  #pipVideo {
    width: 60px;
    height: 40px;
    position: fixed;
    bottom: 10px;
    right: 10px;
    visibility: hidden; /* opacity:0 は不可 */
  }
</style>
</head>
<body>

<div id="clock"></div>
<div class="rate">USD/JPY: <span id="usd">--</span></div>
<div class="rate">日経225: <span id="nk">--</span></div>

<button id="pipButton">PiP開始</button>

<!-- Safari が PiP 対象として認識する動画 -->
<video id="pipVideo" playsinline muted loop>
  <source src="https://raramimi.github.io/pip/pip.mp4" type="video/mp4">
</video>

<script>
// 時計
function updateClock() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2, '0');
  const m = String(now.getMinutes()).padStart(2, '0');
  const s = String(now.getSeconds()).padStart(2, '0');
  document.getElementById('clock').textContent = `${h}:${m}:${s}`;
}
setInterval(updateClock, 1000);
updateClock();

// Yahoo Finance API
async function fetchRate(url) {
  const res = await fetch(url);
  const json = await res.json();
  const result = json.chart.result[0];
  return result.meta.regularMarketPrice;
}

let lastUSD = null;
let lastNK = null;

async function updateRates() {
  try {
    const usd = await fetchRate("https://query1.finance.yahoo.com/v8/finance/chart/USDJPY=X");
    const nk  = await fetchRate("https://query1.finance.yahoo.com/v8/finance/chart/NK225M.FGI");

    const usdElem = document.getElementById("usd");
    const nkElem  = document.getElementById("nk");

    usdElem.textContent = usd;
    nkElem.textContent  = nk;

    if (lastUSD !== null) usdElem.style.color = usd > lastUSD ? "#0f0" : "#f33";
    if (lastNK !== null)  nkElem.style.color  = nk  > lastNK  ? "#0f0" : "#f33";

    lastUSD = usd;
    lastNK  = nk;

  } catch (e) {
    document.getElementById("usd").textContent = "ERR";
    document.getElementById("nk").textContent = "ERR";
  }
}
updateRates();
setInterval(updateRates, 30000);

// PiP（Safari対応）
const video = document.getElementById("pipVideo");

document.getElementById("pipButton").addEventListener("click", async () => {
  try {
    await video.play();  // Safari が「ユーザー操作で再生」と認識
    await video.requestPictureInPicture();
  } catch (e) {
    alert("PiP error: " + e.message);
  }
});
</script>

</body>
</html>
